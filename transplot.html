<!--TransitPlotter.html-->
<!DOCTYPE html>
<meta charset="utf-8">
<body>
<style>
path{
  
  stroke-width:1pt;
  stroke:#000;
  fill:none;
}
svg{
	position:absolute;
  float:left;
}
</style>
<script src="bower_components/d3/d3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- <script src="bower_components/jquery/dist/jquery.min.js"></script> -->

<script>

var W_height=window.outerHeight,
	W_width=window.outerWidth;

var currentAgency;
var routeGeo;
var scale;
var stopGeo;
var projection, path,
geoJson, GeoData;

function getGraphData(AgencyID){
	//We use the availabs api to retrieve route data of specified id
	var routeUrl = "http://api.availabs.org/gtfs/agency/"+AgencyID+"/routes";
	
	currentAgency = AgencyID;
	d3.json(routeUrl,function(err,data){
		if(err) console.log(err);

		console.log(data);
		routeGeo = data;
		plotGraph(routeGeo);
	});
}

function getStopData(AgencyID){
	var stopUrl = "http://localhost:1337/agency/"+AgencyID+"/stops";

	d3.json(topUrl,function(err,data){
		if(err) console.log(err);

		console.log(data);
		stopGeo = data;
		plotStops(stopGeo);
	});	
}

function plotStops(StopData){
	
}

function plotGraph(GeoData){
	bbox = GeoData.bbox,
	scale = .95/ Math.max( (bbox[3] - bbox[1])/W_width, (bbox[2] - bbox[0])/W_height  );

	console.log(bbox);
	console.log(scale);	

	geoJson = topojson.feature(GeoData,GeoData.objects.routes)
	projection = d3.geo.mercator()
            .center(GeoData.transform.translate)
            .scale(50*scale)
            
    path = d3.geo.path().projection(projection);
    var x1,x2,y1,y2,bounds;
    bounds = path.bounds(geoJson);
    /*Here we want to resize the image of the paths to fit the svg*/
    /*get the bounds of the figure*/
    x1 = bounds[0][0], x2 = bounds[1][0],y1 = bounds[0][1], y2 = bounds[1][1];
    /*set the frame of the svg to fit the size of our figure*/
    height = y2-y1;
    width = x2-x1;
	var svg = d3.select("body").append("svg")
				.attr("height",height+10)
				.attr("width", width+10);
	var group = svg.append("g").attr("id","plot");
				//translate our figure in the svg to upper left corner*/
				group.attr("transform",function(){return "translate("+(0-x1)+","+(0-y1)+")";  });

	var paths = group.selectAll("path").data(geoJson.features)
					.enter().append("path")
					.attr("id",function(d){return d.properties.route_id;})
					.style("stroke",function(d){return "#"+d.properties.route_color;})

					paths.attr("d",path);

}


 getGraphData(109);


</script>
